<!--
Helios - Sunshine Weather App with Authentication
Version 5.1 - User Authentication System
Copyright ¬© 2025 Skyler Mydler / Killian Bleu. All rights reserved.

This code and all associated concepts, designs, and implementations are the 
exclusive property of the copyright holder. No part of this code may be 
reproduced, distributed, or transmitted in any form or by any means without 
the prior written permission of the copyright holder.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios - Sunshine Weather</title>
    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* AUTH SCREENS */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 40px);
        }

        .auth-box {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .auth-box h1 {
            font-size: 36px;
            color: #FFA500;
            margin-bottom: 8px;
            text-align: center;
        }

        .auth-box .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #FFA500;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .auth-switch a {
            color: #FFA500;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #ffe0e0;
            color: #cc0000;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* DASHBOARD */
        #dashboardView {
            display: none;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 18px;
            opacity: 0.95;
        }

        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            font-weight: 500;
        }

        .user-bar .username {
            font-size: 16px;
        }

        .btn-logout {
            background: rgba(255,255,255,0.3);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.4);
        }

        .city-limit-notice {
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            font-size: 14px;
            text-align: center;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        #searchInput {
            flex: 1;
            padding: 18px 20px;
            border: none;
            font-size: 16px;
            outline: none;
        }

        #searchBtn {
            padding: 18px 30px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        #searchBtn:hover {
            opacity: 0.9;
        }

        #searchResults {
            display: none;
            background: white;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            position: absolute;
            width: 100%;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #FFF9F0;
        }

        .search-result-item strong {
            color: #333;
            font-weight: 600;
            display: block;
            margin-bottom: 3px;
        }

        .search-result-item .city-details {
            font-size: 14px;
            color: #999;
        }

        .cities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .city-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .city-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
        }

        .delete-city-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #ff4444;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: background 0.2s;
            z-index: 10;
        }

        .delete-city-btn:hover {
            background: #cc0000;
        }

        .city-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .city-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .local-time {
            font-size: 14px;
            color: #666;
        }

        .helio-score-large {
            font-size: 48px;
            font-weight: 700;
            margin: 12px 0;
        }

        .score-0, .score-1 { color: #1a237e; }
        .score-2 { color: #5B9BD5; }
        .score-3 { color: #FFB347; }
        .score-4 { color: #FFA500; }
        .score-5 { color: #FFD700; }

        .weather-details {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            font-size: 14px;
            color: #666;
        }

        .weather-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN VIEW -->
        <div id="loginView" class="auth-container">
            <div class="auth-box">
                <h1>‚òÄÔ∏è Helios</h1>
                <p class="subtitle">Track bright moments for better mental health</p>
                
                <div id="loginError" class="error-message"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="rememberMe" checked>
                            <span style="font-weight: normal;">Remember me</span>
                        </label>
                    </div>
                    <button type="submit" class="btn-primary" id="loginBtn">Log In</button>
                </form>
                
                <div class="auth-switch">
                    Don't have an account? <a href="#" id="showSignup">Sign up</a>
                </div>
            </div>
        </div>

        <!-- SIGNUP VIEW -->
        <div id="signupView" class="auth-container" style="display: none;">
            <div class="auth-box">
                <h1>‚òÄÔ∏è Helios</h1>
                <p class="subtitle">Create your account to start tracking sunshine</p>
                
                <div id="signupError" class="error-message"></div>
                
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupUsername">Username</label>
                        <input type="text" id="signupUsername" required minlength="3" maxlength="20" autocomplete="username">
                        <small style="color: #666; font-size: 12px;">3-20 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required minlength="6" autocomplete="new-password">
                        <small style="color: #666; font-size: 12px;">At least 6 characters</small>
                    </div>
                    <div class="form-group">
                        <label for="signupPasswordConfirm">Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" required minlength="6" autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn-primary" id="signupBtn">Create Account</button>
                </form>
                
                <div class="auth-switch">
                    Already have an account? <a href="#" id="showLogin">Log in</a>
                </div>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView">
            <div class="user-bar">
                <span class="username">Welcome, <span id="displayUsername"></span>!</span>
                <button class="btn-logout" id="logoutBtn">Logout</button>
            </div>

            <div class="city-limit-notice">
                üí° You can save up to 6 cities to your dashboard
            </div>

            <div class="header">
                <h1>
                    <span>‚òÄÔ∏è</span>
                    <span>Helios</span>
                </h1>
                <p>Find Your Sunshine</p>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search for a city..."
                        autocomplete="off"
                    >
                    <button id="searchBtn">Search</button>
                </div>
                <div id="searchResults"></div>
            </div>

            <div id="citiesGrid" class="cities-grid"></div>
            
            <div id="loadingCities" class="loading" style="display: none;">
                Loading your cities...
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const WORKER_URL = 'https://helios.skyler-mydler.workers.dev';
        const AUTH_TOKEN = 'helios-secure-2025';

        // ============================================================
        // STATE
        // ============================================================
        let currentUser = null;
        let sessionToken = null;
        let savedCities = [];
        let searchTimeout;

        // ============================================================
        // ICONS
        // ============================================================
        const icons = {
            sun: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>',
            partlyCloudy: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/><path d="M13 22H7a5 5 0 1 1 .3-10h1.7"/></svg>',
            cloudy: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>',
            rainy: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>',
            snow: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m10 20-5.5-5.5M2 17l3 3M22 17l-3 3M16 20l5.5-5.5M20 7l-3-3M2 7l3-3M12 10V2M8 6l4-4 4 4M12 14v8M8 18l4 4 4-4"/></svg>',
            thermometer: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
            cloud: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>',
            droplet: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>'
        };

        // ============================================================
        // AUTHENTICATION
        // ============================================================
        async function signup(username, password) {
            const response = await fetch(`${WORKER_URL}/auth/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            return data;
        }

        async function login(username, password) {
            const response = await fetch(`${WORKER_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            return data;
        }

        async function logout() {
            if (sessionToken) {
                await fetch(`${WORKER_URL}/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
            }
            
            sessionToken = null;
            currentUser = null;
            localStorage.removeItem('heliosToken');
            showLoginView();
        }

        async function getUserCities() {
            const response = await fetch(`${WORKER_URL}/user/cities`, {
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            });
            
            const data = await response.json();
            if (!response.ok) {
                if (response.status === 401) {
                    logout();
                    return [];
                }
                throw new Error(data.error);
            }
            return data.cities;
        }

        async function saveCitiesToServer() {
            const citiesToSave = savedCities.map(city => ({
                city_name: city.name,
                latitude: city.latitude,
                longitude: city.longitude
            }));

            const response = await fetch(`${WORKER_URL}/user/cities`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`
                },
                body: JSON.stringify({ cities: citiesToSave })
            });
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
        }

        // ============================================================
        // VIEW MANAGEMENT
        // ============================================================
        function showLoginView() {
            document.getElementById('loginView').style.display = 'flex';
            document.getElementById('signupView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'none';
        }

        function showSignupView() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('signupView').style.display = 'flex';
            document.getElementById('dashboardView').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('signupView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('displayUsername').textContent = currentUser;
        }

        // ============================================================
        // WEATHER DATA
        // ============================================================
        async function fetchWeatherData(lat, lon, timezone) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code,cloud_cover&daily=sunrise,sunset&timezone=${timezone}`;
            const response = await fetch(url);
            return await response.json();
        }

        async function calculateHelioScore(solarElevation, weatherCode, cloudCover) {
            const response = await fetch(`${WORKER_URL}/calculate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Auth-Token': AUTH_TOKEN
                },
                body: JSON.stringify({
                    solarElevation,
                    weatherCode,
                    cloudCover
                })
            });
            
            const data = await response.json();
            return data.score;
        }

        // ============================================================
        // CITY SEARCH
        // ============================================================
        async function searchCities(query) {
            try {
                const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('searchResults');
                
                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-result-item">No cities found</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                resultsDiv.innerHTML = data.results.map(city => {
                    const locationParts = [city.name, city.admin1, city.country].filter(Boolean);
                    return `
                        <div class="search-result-item" onclick="selectCity(${city.latitude}, ${city.longitude}, '${city.name.replace(/'/g, "\\'")}', '${city.timezone}')">
                            <strong>${city.name}</strong>
                            <div class="city-details">${locationParts.slice(1).join(', ')}</div>
                        </div>
                    `;
                }).join('');
                
                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function selectCity(lat, lon, name, timezone) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
            
            if (savedCities.length >= 6) {
                alert('You can only save up to 6 cities. Please delete one first.');
                return;
            }
            
            if (savedCities.some(c => c.latitude === lat && c.longitude === lon)) {
                alert('This city is already in your list!');
                return;
            }
            
            document.getElementById('loadingCities').style.display = 'block';
            
            const weatherData = await fetchWeatherData(lat, lon, timezone);
            
            savedCities.push({
                name,
                latitude: lat,
                longitude: lon,
                timezone,
                weatherData
            });
            
            await saveCitiesToServer();
            await renderCityCards();
            
            document.getElementById('loadingCities').style.display = 'none';
        }

        async function deleteCity(index) {
            if (confirm(`Remove ${savedCities[index].name} from your dashboard?`)) {
                savedCities.splice(index, 1);
                await saveCitiesToServer();
                await renderCityCards();
            }
        }

        // ============================================================
        // RENDERING
        // ============================================================
        function getCurrentHelioScore(city) {
            const now = new Date();
            const sunPos = SunCalc.getPosition(now, city.latitude, city.longitude);
            const solarElevation = sunPos.altitude * (180 / Math.PI);
            
            const currentHour = now.getUTCHours();
            const weatherCode = city.weatherData.hourly.weather_code[currentHour];
            const cloudCover = city.weatherData.hourly.cloud_cover[currentHour];
            
            return { solarElevation, weatherCode, cloudCover };
        }

        async function renderCityCards() {
            const grid = document.getElementById('citiesGrid');
            
            if (savedCities.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: white; font-size: 18px;">Search for a city above to add it to your dashboard</div>';
                return;
            }
            
            const cards = await Promise.all(savedCities.map(async (city, index) => {
                const { solarElevation, weatherCode, cloudCover } = getCurrentHelioScore(city);
                const score = await calculateHelioScore(solarElevation, weatherCode, cloudCover);
                
                const now = new Date();
                const localTime = now.toLocaleTimeString('en-US', { 
                    timeZone: city.timezone,
                    hour: 'numeric',
                    minute: '2-digit'
                });
                
                const scoreClass = `score-${Math.round(score)}`;
                const temp = Math.round(city.weatherData.hourly.temperature_2m[now.getUTCHours()]);
                
                return `
                    <div class="city-card">
                        <button class="delete-city-btn" onclick="event.stopPropagation(); deleteCity(${index})">√ó</button>
                        <div class="city-header">
                            <div>
                                <div class="city-name">${city.name}</div>
                                <div class="local-time">${localTime}</div>
                            </div>
                        </div>
                        <div class="helio-score-large ${scoreClass}">${score.toFixed(1)}</div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                ${icons.thermometer}
                                <span>${temp}¬∞C</span>
                            </div>
                            <div class="weather-detail">
                                ${icons.cloud}
                                <span>${cloudCover}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }));
            
            grid.innerHTML = cards.join('');
        }

        // ============================================================
        // EVENT HANDLERS
        // ============================================================
        document.getElementById('showSignup').addEventListener('click', (e) => {
            e.preventDefault();
            showSignupView();
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            showLoginView();
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            btn.disabled = true;
            btn.textContent = 'Logging in...';
            errorDiv.classList.remove('show');
            
            try {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                const remember = document.getElementById('rememberMe').checked;
                
                const data = await login(username, password);
                sessionToken = data.token;
                currentUser = data.username;
                
                if (remember) {
                    localStorage.setItem('heliosToken', sessionToken);
                }
                
                // Load user's cities
                const cities = await getUserCities();
                savedCities = [];
                
                for (const city of cities) {
                    const weatherData = await fetchWeatherData(city.latitude, city.longitude, 'auto');
                    savedCities.push({
                        name: city.city_name,
                        latitude: city.latitude,
                        longitude: city.longitude,
                        timezone: 'auto',
                        weatherData
                    });
                }
                
                showDashboard();
                await renderCityCards();
                
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Log In';
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('signupBtn');
            const errorDiv = document.getElementById('signupError');
            
            btn.disabled = true;
            btn.textContent = 'Creating account...';
            errorDiv.classList.remove('show');
            
            try {
                const username = document.getElementById('signupUsername').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupPasswordConfirm').value;
                
                if (password !== confirmPassword) {
                    throw new Error('Passwords do not match');
                }
                
                const data = await signup(username, password);
                sessionToken = data.token;
                currentUser = data.username;
                
                localStorage.setItem('heliosToken', sessionToken);
                
                showDashboard();
                await renderCityCards();
                
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);

        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => searchCities(query), 300);
        });

        document.getElementById('searchBtn').addEventListener('click', () => {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length >= 2) {
                searchCities(query);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        // ============================================================
        // INITIALIZATION
        // ============================================================
        async function init() {
            // Check for saved session
            const savedToken = localStorage.getItem('heliosToken');
            
            if (savedToken) {
                sessionToken = savedToken;
                
                try {
                    // Verify token by trying to get cities
                    const cities = await getUserCities();
                    
                    // Token is valid, load cities
                    savedCities = [];
                    for (const city of cities) {
                        const weatherData = await fetchWeatherData(city.latitude, city.longitude, 'auto');
                        savedCities.push({
                            name: city.city_name,
                            latitude: city.latitude,
                            longitude: city.longitude,
                            timezone: 'auto',
                            weatherData
                        });
                    }
                    
                    // Get username from token (we'll need to decode it or store it)
                    currentUser = 'User'; // For now
                    showDashboard();
                    await renderCityCards();
                    
                } catch (error) {
                    // Token invalid, show login
                    localStorage.removeItem('heliosToken');
                    showLoginView();
                }
            } else {
                showLoginView();
            }
        }

        // Start app
        init();

        // Auto-refresh weather every 5 minutes
        setInterval(async () => {
            if (currentUser && savedCities.length > 0) {
                for (let city of savedCities) {
                    city.weatherData = await fetchWeatherData(city.latitude, city.longitude, city.timezone);
                }
                await renderCityCards();
            }
        }, 300000);
    </script>
</body>
</html>
