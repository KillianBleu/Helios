<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios - Find Your Brightness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 18px;
            opacity: 0.95;
        }

        .back-button {
            display: none;
            background: white;
            color: #FFA500;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .back-button:hover {
            transform: translateY(-2px);
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        #searchInput {
            flex: 1;
            padding: 18px 20px;
            border: none;
            font-size: 16px;
            outline: none;
        }

        #searchBtn {
            padding: 18px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        #searchBtn:hover {
            opacity: 0.9;
        }

        #searchResults {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        .search-result-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8f8f8;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .city-details {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state h2 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 18px;
            opacity: 0.9;
        }

        #citiesGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .city-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .city-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .city-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .city-info {
            flex: 1;
        }

        .city-name {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .city-country {
            font-size: 14px;
            color: #666;
        }

        .helio-score-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .helio-score-circle.excellent { background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); } /* Bright gold/orange */
        .helio-score-circle.great { background: linear-gradient(135deg, #FFA500 0%, #FF7F00 100%); } /* Orange */
        .helio-score-circle.good { background: linear-gradient(135deg, #FF6B9D 0%, #C44569 100%); } /* Pink/rose */
        .helio-score-circle.moderate { background: linear-gradient(135deg, #B565D8 0%, #8B3DFF 100%); } /* Purple */
        .helio-score-circle.fair { background: linear-gradient(135deg, #5F9DF7 0%, #3B5998 100%); } /* Blue */
        .helio-score-circle.poor { background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%); } /* Blue-gray */
        .helio-score-circle.verypoor { background: linear-gradient(135deg, #5A4A42 0%, #3E2723 100%); } /* Brown */
        .helio-score-circle.dismal { background: linear-gradient(135deg, #2C3E50 0%, #1A252F 100%); } /* Dark blue-gray */
        .helio-score-circle.night { background: linear-gradient(135deg, #1e3a5f 0%, #0f1419 100%); } /* Dark blue */

        .city-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .delete-city {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ff4444;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .delete-city:hover {
            opacity: 1;
        }

        #detailView {
            display: none;
        }

        .detail-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .detail-city-name {
            font-size: 36px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .detail-helio-score {
            font-size: 72px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .detail-score-label {
            font-size: 24px;
            color: #666;
        }

        .detail-daily-avg {
            position: absolute;
            bottom: 20px;
            right: 20px;
            text-align: right;
        }

        .detail-daily-avg-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-daily-avg-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .detail-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .detail-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            font-size: 14px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .detail-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .hourly-grid {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .hourly-item {
            min-width: 90px;
            text-align: center;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 12px;
            flex-shrink: 0;
        }

        .hourly-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .hourly-icon {
            font-size: 32px;
            margin: 8px 0;
        }

        .hourly-score {
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0;
        }

        .hourly-score.excellent { color: #FF8C00; font-weight: 600; } /* Dark orange - readable */
        .hourly-score.great { color: #FF7F00; font-weight: 600; } /* Orange */
        .hourly-score.good { color: #C44569; font-weight: 600; } /* Deep pink */
        .hourly-score.moderate { color: #8B3DFF; font-weight: 600; } /* Purple */
        .hourly-score.fair { color: #3B5998; font-weight: 600; } /* Blue */
        .hourly-score.poor { color: #2D3748; font-weight: 600; } /* Dark gray */
        .hourly-score.verypoor { color: #3E2723; font-weight: 600; } /* Dark brown */
        .hourly-score.dismal { color: #1A252F; font-weight: 600; } /* Very dark */
        .hourly-score.night { color: #666; }

        .hourly-temp {
            font-size: 14px;
            color: #666;
        }

        .forecast-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .forecast-day {
            display: grid;
            grid-template-columns: 120px 80px 1fr;
            align-items: center;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 12px;
        }

        .forecast-score {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
        }

        .forecast-score.excellent { color: #FF8C00; font-weight: 600; }
        .forecast-score.great { color: #FF7F00; font-weight: 600; }
        .forecast-score.good { color: #C44569; font-weight: 600; }
        .forecast-score.moderate { color: #8B3DFF; font-weight: 600; }
        .forecast-score.fair { color: #3B5998; font-weight: 600; }
        .forecast-score.poor { color: #2D3748; font-weight: 600; }
        .forecast-score.verypoor { color: #3E2723; font-weight: 600; }
        .forecast-score.dismal { color: #1A252F; font-weight: 600; }

        .hourly-item.daytime {
            background: rgba(255, 200, 0, 0.25) !important; /* More visible yellow */
        }

        .hourly-item.nighttime {
            background: rgba(30, 58, 95, 0.25) !important; /* More visible blue */
        }

        .pattern-bar {
            display: flex;
            height: 50px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
        }

        .pattern-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .pattern-legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 12px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: white;
            opacity: 0.8;
        }

        /* ============================================================ */
        /* AUTHENTICATION OVERLAY STYLES */
        /* ============================================================ */
        
        #authOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #authOverlay.hidden {
            display: none !important;
        }

        .auth-box {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .auth-box h1 {
            font-size: 36px;
            color: #FFA500;
            margin-bottom: 8px;
            text-align: center;
        }

        .auth-box .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .auth-form-group {
            margin-bottom: 20px;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .auth-form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: #FFA500;
        }

        .auth-form-group small {
            display: block;
            margin-top: 4px;
            color: #999;
            font-size: 12px;
        }

        .btn-auth {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
        }

        .btn-auth:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .auth-switch a {
            color: #FFA500;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: #ffe0e0;
            color: #cc0000;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .user-bar {
            display: none;
            justify-content: center;  /* Center the content */
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            font-weight: 500;
            position: relative;  /* For absolute positioning of logout button */
        }

        .user-bar.visible {
            display: flex;
        }

        .btn-logout {
            background: rgba(255,255,255,0.3);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            position: absolute;  /* Position on the right */
            right: 20px;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.4);
        }

        .city-limit-notice {
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .city-limit-notice.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- ============================================================ -->
    <!-- AUTHENTICATION OVERLAY -->
    <!-- ============================================================ -->
    <div id="authOverlay">
        <div class="auth-box">
            <!-- Login Form -->
            <div id="loginForm">
                <h1>‚òÄÔ∏è Helios</h1>
                <p class="subtitle">Your Anti-Gloom Weather App</p>
                
                <div id="loginError" class="auth-error"></div>
                
                <form id="loginFormElement">
                    <div class="auth-form-group">
                        <label for="loginUsername">Username</label>
                        <input 
                            type="text" 
                            id="loginUsername" 
                            required 
                            autocomplete="username"
                        >
                    </div>
                    <div class="auth-form-group">
                        <label for="loginPassword">Password</label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            required 
                            autocomplete="current-password"
                        >
                    </div>
                    <div class="auth-form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                            <input type="checkbox" id="rememberMe" checked style="width: auto; margin: 0;">
                            <span>Remember me</span>
                        </label>
                    </div>
                    <button type="submit" class="btn-auth" id="loginBtn">Log In</button>
                </form>
                
                <div class="auth-switch">
                    Don't have an account? <a href="#" id="showSignupLink">Sign up</a>
                </div>
                
                <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #999;">
                    ¬© 2025 Helios. All rights reserved.
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <h1>‚òÄÔ∏è Helios</h1>
                <p class="subtitle">Create your account to start tracking sunshine</p>
                
                <div id="signupError" class="auth-error"></div>
                
                <form id="signupFormElement">
                    <div class="auth-form-group">
                        <label for="signupUsername">Username</label>
                        <input 
                            type="text" 
                            id="signupUsername" 
                            required 
                            minlength="3" 
                            maxlength="20" 
                            autocomplete="off"
                        >
                        <small>3-20 characters (case-insensitive)</small>
                    </div>
                    <div class="auth-form-group">
                        <label for="signupPassword">Password</label>
                        <input 
                            type="password" 
                            id="signupPassword" 
                            required 
                            minlength="6" 
                            autocomplete="new-password"
                        >
                        <small>At least 6 characters</small>
                    </div>
                    <div class="auth-form-group">
                        <label for="signupPasswordConfirm">Confirm Password</label>
                        <input 
                            type="password" 
                            id="signupPasswordConfirm" 
                            required 
                            minlength="6" 
                            autocomplete="new-password"
                        >
                    </div>
                    <button type="submit" class="btn-auth" id="signupBtn">Create Account</button>
                </form>
                
                <div class="auth-switch">
                    Already have an account? <a href="#" id="showLoginLink">Log in</a>
                </div>
                
                <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #999;">
                    ¬© 2025 Helios. All rights reserved.
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- MAIN APPLICATION (Original V5.2 UI) -->
    <!-- ============================================================ -->
    
    <!-- User Bar (shown when logged in) -->
    <div class="container">
        <div class="user-bar" id="userBar">
            <span>Welcome, <span id="displayUsername"></span>!</span>
            <button class="btn-logout" id="logoutBtn">Logout</button>
        </div>

        <!-- City Limit Notice -->
        <div class="city-limit-notice" id="cityLimitNotice">
            üí° You can save up to 6 cities to your dashboard
        </div>
    </div>
    
    <button class="back-button" id="backButton" onclick="showCitiesView()">&larr; Back to Cities</button>
    
    <div class="container">
        <div class="header">
            <h1>‚òÄÔ∏è Helios</h1>
            <p>Find Your Brightness</p>
        </div>

        <div id="citiesView">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search for a city...">
                    <button id="searchBtn">Search</button>
                </div>
                <div id="searchResults"></div>
            </div>

            <div class="empty-state" id="emptyState">
                <h2>Welcome to Helios</h2>
                <p>Search for a city to add it to your dashboard</p>
            </div>

            <div id="citiesGrid"></div>
        </div>

        <div id="detailView">
            <div class="detail-header">
                <div class="detail-city-name" id="detailCityName"></div>
                <div class="detail-helio-score" id="detailHelioScore"></div>
                <div class="detail-score-label" id="detailScoreLabel"></div>
            </div>

            <div class="detail-section">
                <h2>Current Conditions</h2>
                <div class="detail-grid"></div>
            </div>

            <div class="detail-section">
                <!-- Sunshine pattern will be inserted here -->
            </div>

            <div class="detail-section">
                <!-- Hourly forecast will be inserted here -->
            </div>

            <div class="detail-section">
                <!-- 7-day forecast will be inserted here -->
            </div>
        </div>
    </div>

    <footer>
        &copy; 2025 Helios Weather App. All rights reserved.
    </footer>

    <script>
// ============================================================
// CONFIGURATION
// ============================================================

const WORKER_URL = 'https://helios.skyler-mydler.workers.dev';
let API_TOKEN = localStorage.getItem('heliosApiToken') || '';

// Authentication state
let sessionToken = null;
let currentUser = null;
let savedCities = []; // Will be loaded from server after login

// ============================================================
// AUTHENTICATION SYSTEM
// ============================================================

// Auth UI Functions
function showLoginForm() {
    console.log('showLoginForm called');
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('signupForm').style.display = 'none';
    document.getElementById('loginError').classList.remove('show');
    document.getElementById('loginError').textContent = '';
}

function showSignupForm() {
    console.log('showSignupForm called');
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'block';
    document.getElementById('signupError').classList.remove('show');
    document.getElementById('signupError').textContent = '';
    // Clear form to prevent autofill security issue
    document.getElementById('signupUsername').value = '';
    document.getElementById('signupPassword').value = '';
    document.getElementById('signupPasswordConfirm').value = '';
}

function hideAuthOverlay() {
    document.getElementById('authOverlay').classList.add('hidden');
    document.getElementById('userBar').classList.add('visible');
    document.getElementById('cityLimitNotice').classList.add('visible');
}

function showAuthOverlay() {
    document.getElementById('authOverlay').classList.remove('hidden');
    document.getElementById('userBar').classList.remove('visible');
    document.getElementById('cityLimitNotice').classList.remove('visible');
}

// API Functions
async function handleLogin() {
    console.log('handleLogin called');
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const remember = document.getElementById('rememberMe').checked;
    const errorDiv = document.getElementById('loginError');
    const btn = document.getElementById('loginBtn');
    
    console.log('Login attempt:', { username, hasPassword: !!password, remember });
    
    if (!username || !password) {
        errorDiv.textContent = 'Please enter username and password';
        errorDiv.classList.add('show');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Logging in...';
    errorDiv.classList.remove('show');
    
    try {
        console.log('Sending login request to:', `${WORKER_URL}/auth/login`);
        const response = await fetch(`${WORKER_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        console.log('Login response status:', response.status);
        const data = await response.json();
        console.log('Login response data:', data);
        
        if (!response.ok) throw new Error(data.error);
        
        sessionToken = data.token;
        currentUser = data.username;
        API_TOKEN = data.mlToken;  // SECURITY: Receive ML token from server, never hardcoded
        
        // ALWAYS save to sessionStorage (persists during tab session, cleared on tab close)
        sessionStorage.setItem('heliosToken', sessionToken);
        sessionStorage.setItem('heliosUsername', currentUser);
        sessionStorage.setItem('heliosApiToken', API_TOKEN);
        
        // ONLY save to localStorage if "remember me" is checked (persists after tab close)
        if (remember) {
            localStorage.setItem('heliosRememberUser', currentUser);
        } else {
            localStorage.removeItem('heliosRememberUser');
        }
        
        document.getElementById('displayUsername').textContent = currentUser;
        
        // Load user cities
        await loadUserCitiesFromServer();
        
        hideAuthOverlay();
        renderCityCards();
        
        // Start auto-refresh
        startAutoRefresh();
        
    } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = error.message || 'Login failed';
        errorDiv.classList.add('show');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Log In';
        // Clear password field for security
        document.getElementById('loginPassword').value = '';
    }
}

async function handleSignup() {
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('signupPasswordConfirm').value;
    const errorDiv = document.getElementById('signupError');
    const btn = document.getElementById('signupBtn');
    
    if (!username || !password || !confirmPassword) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.classList.add('show');
        return;
    }

    if (password !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.classList.add('show');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Creating account...';
    errorDiv.classList.remove('show');
    
    try {
        const response = await fetch(`${WORKER_URL}/auth/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error);
        
        sessionToken = data.token;
        currentUser = data.username;
        API_TOKEN = data.mlToken;  // SECURITY: Receive ML token from server, never hardcoded
        
        // ALWAYS save to sessionStorage (persists during tab session)
        sessionStorage.setItem('heliosToken', sessionToken);
        sessionStorage.setItem('heliosUsername', currentUser);
        sessionStorage.setItem('heliosApiToken', API_TOKEN);
        
        // New accounts get "remember me" by default
        localStorage.setItem('heliosRememberUser', currentUser);
        
        document.getElementById('displayUsername').textContent = currentUser;
        
        // New user starts with empty cities
        savedCities = [];
        
        hideAuthOverlay();
        renderCityCards();
        
        // Start auto-refresh
        startAutoRefresh();
        
    } catch (error) {
        errorDiv.textContent = error.message || 'Signup failed';
        errorDiv.classList.add('show');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }
}

async function handleLogout() {
    // Check if user had "remember me" enabled
    const hadRememberMe = !!localStorage.getItem('heliosRememberUser');
    const rememberedUsername = localStorage.getItem('heliosRememberUser');
    
    if (sessionToken) {
        try {
            await fetch(`${WORKER_URL}/auth/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
    }
    
    sessionToken = null;
    currentUser = null;
    savedCities = [];
    API_TOKEN = '';  // Clear ML token on logout
    
    // Stop auto-refresh
    stopAutoRefresh();
    
    // Clear session storage (active session)
    sessionStorage.removeItem('heliosToken');
    sessionStorage.removeItem('heliosUsername');
    sessionStorage.removeItem('heliosApiToken');
    
    // Clear localStorage tokens but keep remember me preference
    localStorage.removeItem('heliosToken');
    localStorage.removeItem('heliosUsername');
    localStorage.removeItem('heliosApiToken');
    
    // Only clear credentials if "remember me" was NOT checked
    if (!hadRememberMe) {
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
        localStorage.removeItem('heliosRememberUser');
    } else {
        // Restore username for convenience
        document.getElementById('loginUsername').value = rememberedUsername;
        document.getElementById('loginPassword').value = '';
    }
    
    document.getElementById('rememberMe').checked = true;  // Reset to default checked
    
    showAuthOverlay();
    showLoginForm();
    renderCityCards();
}

async function loadUserCitiesFromServer() {
    try {
        const response = await fetch(`${WORKER_URL}/user/cities`, {
            headers: { 'Authorization': `Bearer ${sessionToken}` }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            if (response.status === 401) {
                throw new Error('Session expired');
            }
            throw new Error(data.error);
        }
        
        // Load cities
        savedCities = data.cities.map(city => ({
            name: city.city_name,
            latitude: city.latitude,  // Match what renderCityCards expects
            longitude: city.longitude,  // Match what renderCityCards expects
            timezone: city.timezone || 'auto'
        }));
        
    } catch (error) {
        console.error('Error loading cities:', error);
        if (error.message === 'Session expired') {
            handleLogout();
        }
        throw error;
    }
}

async function saveCitiesToServer() {
    if (!sessionToken) return;
    
    // Check 6 city limit
    if (savedCities.length > 6) {
        alert('Maximum 6 cities allowed. Please delete some cities first.');
        return false;
    }
    
    try {
        const citiesToSave = savedCities.map((city, index) => ({
            city_name: city.name,
            latitude: city.latitude,  // Use consistent property names
            longitude: city.longitude,  // Use consistent property names
            timezone: city.timezone || 'auto'
        }));

        const response = await fetch(`${WORKER_URL}/user/cities`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionToken}`
            },
            body: JSON.stringify({ cities: citiesToSave })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            if (response.status === 401) {
                handleLogout();
                return false;
            }
            throw new Error(data.error);
        }
        
        return true;
        
    } catch (error) {
        console.error('Error saving cities:', error);
        alert('Failed to save cities: ' + error.message);
        return false;
    }
}

// Setup auth event listeners
(function() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupAuthListeners);
    } else {
        setupAuthListeners();
    }
    
    function setupAuthListeners() {
        console.log('Setting up auth listeners...');
        
        const showSignupLink = document.getElementById('showSignupLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const loginForm = document.getElementById('loginFormElement');
        const signupForm = document.getElementById('signupFormElement');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (showSignupLink) {
            showSignupLink.addEventListener('click', (e) => {
                console.log('Signup link clicked');
                e.preventDefault();
                showSignupForm();
            });
        }

        if (showLoginLink) {
            showLoginLink.addEventListener('click', (e) => {
                console.log('Login link clicked');
                e.preventDefault();
                showLoginForm();
            });
        }

        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                console.log('Login form submitted');
                e.preventDefault();
                handleLogin();
            });
        }

        if (signupForm) {
            signupForm.addEventListener('submit', (e) => {
                console.log('Signup form submitted');
                e.preventDefault();
                handleSignup();
            });
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', handleLogout);
        }
        
        console.log('Auth listeners setup complete');
    }
})();

// Check for existing session on page load
window.addEventListener('load', async () => {
    // Priority 1: Check sessionStorage (active session, persists on refresh)
    let savedToken = sessionStorage.getItem('heliosToken');
    let savedUsername = sessionStorage.getItem('heliosUsername');
    let savedApiToken = sessionStorage.getItem('heliosApiToken');
    
    // Priority 2: If no session, check localStorage (remember me)
    if (!savedToken) {
        savedToken = localStorage.getItem('heliosToken');
        savedUsername = localStorage.getItem('heliosUsername');
        savedApiToken = localStorage.getItem('heliosApiToken');
        
        // If restoring from localStorage, also save to sessionStorage
        if (savedToken && savedUsername && savedApiToken) {
            sessionStorage.setItem('heliosToken', savedToken);
            sessionStorage.setItem('heliosUsername', savedUsername);
            sessionStorage.setItem('heliosApiToken', savedApiToken);
        }
    }
    
    // Pre-fill username if remembered
    const rememberedUser = localStorage.getItem('heliosRememberUser');
    if (rememberedUser && !savedToken) {
        document.getElementById('loginUsername').value = rememberedUser;
    }
    
    if (savedToken && savedUsername && savedApiToken) {
        sessionToken = savedToken;
        currentUser = savedUsername;
        API_TOKEN = savedApiToken;  // Restore ML token
        document.getElementById('displayUsername').textContent = currentUser;
        
        try {
            await loadUserCitiesFromServer();
            hideAuthOverlay();
            renderCityCards();
            
            // Start auto-refresh
            startAutoRefresh();
        } catch (error) {
            console.error('Failed to restore session:', error);
            handleLogout();
        }
    } else {
        // No saved session, show login
        showAuthOverlay();
    }
});

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

// Auto-refresh timer
let autoRefreshInterval = null;

const REFRESH_INTERVAL = 300000; // 30 seconds for testing (change to 300000 for 5 minutes)

function startAutoRefresh() {
    console.log('üöÄ startAutoRefresh() function called!');
    
    // Clear any existing interval
    if (autoRefreshInterval) {
        console.log('‚ö†Ô∏è Clearing existing interval');
        clearInterval(autoRefreshInterval);
    }
    
    console.log(`‚è∞ Setting up interval with ${REFRESH_INTERVAL}ms (${REFRESH_INTERVAL/1000} seconds)`);
    
    // Refresh at the specified interval
    autoRefreshInterval = setInterval(async () => {
        const now = new Date().toLocaleTimeString();
        console.log(`üîÑ Auto-refreshing weather data at ${now}...`);
        
        // Only refresh if user is logged in and has cities
        if (savedCities.length > 0 && sessionToken && API_TOKEN) {
            await renderCityCards();
            console.log('‚úÖ Auto-refresh complete');
        } else {
            console.log('‚ö†Ô∏è Skipping auto-refresh (no cities or not logged in)');
        }
    }, REFRESH_INTERVAL);
    
    const startTime = new Date().toLocaleTimeString();
    const intervalMinutes = REFRESH_INTERVAL / 60000;
    console.log(`‚úÖ Auto-refresh started at ${startTime} (updates every ${intervalMinutes} minutes)`);
    console.log(`üìä Current state: cities=${savedCities.length}, hasToken=${!!sessionToken}, hasAPIToken=${!!API_TOKEN}`);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('üõë Auto-refresh stopped');
    }
}

function getScoreLabel(score) {
    if (score >= 4.5) return '‚òÄÔ∏è Excellent';
    if (score >= 3.5) return 'üå§Ô∏è Great';
    if (score >= 2.5) return '‚õÖ Good';
    if (score >= 1.5) return 'üå•Ô∏è Moderate';
    if (score >= 0.5) return '‚òÅÔ∏è Fair';
    if (score > 0) return 'üå´Ô∏è Poor';
    return 'üåô Nighttime';
}

function getScoreColorClass(score) {
    if (score >= 4.5) return 'excellent';  // 4.5-5.0: Bright yellow
    if (score >= 4.0) return 'great';      // 4.0-4.4: Yellow
    if (score >= 3.5) return 'good';       // 3.5-3.9: Light purple/red
    if (score >= 3.0) return 'moderate';   // 3.0-3.4: Deeper red/purple
    if (score >= 2.5) return 'fair';       // 2.5-2.9: Light purple blue
    if (score >= 2.0) return 'poor';       // 2.0-2.4: Deeper purple blue
    if (score >= 1.5) return 'verypoor';   // 1.5-1.9: Light dark bluish brown
    return 'dismal';                        // 1.0-1.4: Dark bluish brown
}

function getWeatherLabel(code) {
    const labels = {
        0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
        45: 'Foggy', 48: 'Rime fog', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Heavy drizzle',
        61: 'Light rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Light snow', 73: 'Snow',
        75: 'Heavy snow', 77: 'Snow grains', 80: 'Rain showers', 81: 'Heavy showers',
        82: 'Violent showers', 85: 'Snow showers', 86: 'Heavy snow showers',
        95: 'Thunderstorm', 96: 'Thunderstorm with hail', 99: 'Severe thunderstorm'
    };
    return labels[code] || 'Unknown';
}

function getWeatherIcon(code) {
    const icons = {
        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
        51: 'üå¶Ô∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è', 61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
        71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è', 77: 'üå®Ô∏è', 80: 'üå¶Ô∏è', 81: 'üåßÔ∏è',
        82: '‚õàÔ∏è', 85: 'üå®Ô∏è', 86: 'üå®Ô∏è', 95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
    };
    return icons[code] || 'üå°Ô∏è';
}

// ============================================================
// CLOUDFLARE WORKER API
// ============================================================

async function fetchScoresFromWorker(lat, lon, cityName, timezone) {
    try {
        if (!API_TOKEN) {
            throw new Error('No token - initialization will handle this');
        }
        
        console.log('Fetching scores for:', cityName, 'Timezone:', timezone);
        
        const response = await fetch(`${WORKER_URL}/calculate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_TOKEN}`
            },
            body: JSON.stringify({
                latitude: lat,
                longitude: lon,
                cityName: cityName,
                timezone: timezone
            })
        });
        
        if (response.status === 401) {
            localStorage.removeItem('heliosApiToken');
            API_TOKEN = '';
            alert('‚ùå Invalid API token. Please refresh and try again.');
            return null;
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('Worker error details:', errorData);
            throw new Error(`Worker API error: ${response.status} - ${errorData.message || 'Unknown error'}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Received scores:', data);
        return data;
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        if (error.message.includes('No token')) {
            return null;
        }
        alert('Unable to load weather data. Please check your connection.');
        return null;
    }
}

// ============================================================
// CITY RENDERING
// ============================================================

async function renderCityCards() {
    const citiesGrid = document.getElementById('citiesGrid');
    const emptyState = document.getElementById('emptyState');
    
    if (savedCities.length === 0) {
        emptyState.style.display = 'block';
        citiesGrid.innerHTML = '';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Keep existing cards, just update them
    const existingCards = Array.from(citiesGrid.children);
    
    for (let index = 0; index < savedCities.length; index++) {
        const city = savedCities[index];
        const scores = await fetchScoresFromWorker(city.latitude, city.longitude, city.name, city.timezone);
        
        const score = scores ? (scores.currentScore || 0) : 0;
        const temp = scores ? (scores.currentTemp || 0) : 0;
        const daily = scores ? (scores.dailyAverage || 0) : 0;
        
        const cardHTML = `
            <div class="city-card" onclick="showCityDetail(savedCities[${index}])" style="position: relative; cursor: pointer;">
                <button class="delete-city" onclick="event.stopPropagation(); deleteCity(${index})">&times;</button>
                <div class="city-card-header">
                    <div class="city-info">
                        <div class="city-name">${city.name}</div>
                        <div class="city-country">${city.admin1 ? city.admin1 + ', ' : ''}${city.country || ''}</div>
                    </div>
                    <div class="helio-score-circle ${score > 0 ? getScoreColorClass(score) : 'night'}">
                        ${score > 0 ? score.toFixed(1) : 'N/A'}
                    </div>
                </div>
                <div class="city-stats">
                    <div class="stat">
                        <div class="stat-label">Current</div>
                        <div class="stat-value">${scores ? getScoreLabel(score) : 'Error'}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Temperature</div>
                        <div class="stat-value">${temp}¬∞F</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Daily Avg</div>
                        <div class="stat-value">${daily > 0 ? daily.toFixed(1) : 'N/A'}</div>
                    </div>
                </div>
            </div>
        `;
        
        if (existingCards[index]) {
            existingCards[index].outerHTML = cardHTML;
        } else {
            citiesGrid.innerHTML += cardHTML;
        }
    }
    
    // Remove extra cards if cities were deleted
    while (citiesGrid.children.length > savedCities.length) {
        citiesGrid.removeChild(citiesGrid.lastChild);
    }
}

async function showCityDetail(city) {
    const scores = await fetchScoresFromWorker(city.latitude, city.longitude, city.name, city.timezone);
    if (!scores) return;
    
    document.getElementById('citiesView').style.display = 'none';
    document.getElementById('detailView').style.display = 'block';
    document.getElementById('backButton').style.display = 'block';
    
    document.getElementById('detailCityName').textContent = city.name;
    document.getElementById('detailHelioScore').textContent = scores.currentScore > 0 ? scores.currentScore.toFixed(1) : 'N/A';
    document.getElementById('detailScoreLabel').textContent = getScoreLabel(scores.currentScore);
    
    // Add daily average to header
    const detailHeader = document.querySelector('.detail-header');
    const existingAvg = detailHeader.querySelector('.detail-daily-avg');
    if (existingAvg) existingAvg.remove(); // Remove if already exists
    
    const dailyAvgHTML = `
        <div class="detail-daily-avg">
            <div class="detail-daily-avg-label">Daily Average</div>
            <div class="detail-daily-avg-value">${scores.dailyAverage > 0 ? scores.dailyAverage.toFixed(1) : 'N/A'}</div>
        </div>
    `;
    detailHeader.insertAdjacentHTML('beforeend', dailyAvgHTML);
    
    // Apply dynamic color to detail score based on value
    const detailScoreEl = document.getElementById('detailHelioScore');
    const scoreClass = scores.currentScore > 0 ? getScoreColorClass(scores.currentScore) : 'night';
    const colorMap = {
        'excellent': 'linear-gradient(135deg, #FFD700 0%, #FF8C00 100%)',
        'great': 'linear-gradient(135deg, #FFA500 0%, #FF7F00 100%)',
        'good': 'linear-gradient(135deg, #FF6B9D 0%, #C44569 100%)',
        'moderate': 'linear-gradient(135deg, #B565D8 0%, #8B3DFF 100%)',
        'fair': 'linear-gradient(135deg, #5F9DF7 0%, #3B5998 100%)',
        'poor': 'linear-gradient(135deg, #4A5568 0%, #2D3748 100%)',
        'verypoor': 'linear-gradient(135deg, #5A4A42 0%, #3E2723 100%)',
        'dismal': 'linear-gradient(135deg, #2C3E50 0%, #1A252F 100%)',
        'night': 'linear-gradient(135deg, #1e3a5f 0%, #0f1419 100%)'
    };
    detailScoreEl.style.background = colorMap[scoreClass];
    detailScoreEl.style.webkitBackgroundClip = 'text';
    detailScoreEl.style.webkitTextFillColor = 'transparent';
    detailScoreEl.style.backgroundClip = 'text';
    
    // Helper function to format time from ISO string in CITY'S timezone
    function formatTime(isoString) {
        if (!isoString) return 'N/A';
        // ISO string includes timezone offset, so Date will parse it correctly
        const date = new Date(isoString);
        // Extract time from the ISO string directly to get city's local time
        const timeMatch = isoString.match(/T(\d{2}):(\d{2})/);
        if (timeMatch) {
            let hour = parseInt(timeMatch[1]);
            const minute = timeMatch[2];
            const ampm = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12 || 12;
            return `${hour}:${minute} ${ampm}`;
        }
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    }
    
    function getLocalTimeFromISO(isoString) {
        // Extract local time from ISO string (e.g., "2024-12-18T14:00-10:00" -> 2 PM)
        const timeMatch = isoString.match(/T(\d{2}):/);
        if (timeMatch) {
            let hour = parseInt(timeMatch[1]);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour} ${ampm}`;
        }
        return new Date(isoString).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
    }
    
    // Current conditions - simplified
    const detailGrid = document.querySelector('.detail-grid');
    detailGrid.innerHTML = `
        <div class="detail-item">
            <div class="detail-label">Temperature</div>
            <div class="detail-value">${scores.currentTemp}¬∞F</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Conditions</div>
            <div class="detail-value">${getWeatherLabel(scores.currentWeatherCode)}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Cloud Cover</div>
            <div class="detail-value">${scores.currentCloudCover}%</div>
        </div>
    `;
    
    // Sunshine pattern bar with time markers
    const patternSection = document.querySelectorAll('.detail-section')[1];
    let patternHTML = '<h2>Today\'s Sunshine Pattern</h2>';
    patternHTML += '<div style="font-size: 13px; color: #666; margin-bottom: 15px;">';
    patternHTML += `${scores.daylightHours} hrs of daylight ¬∑ Sunrise ${formatTime(scores.sunrise)} ¬∑ Sunset ${formatTime(scores.sunset)}`;
    patternHTML += '</div>';
    
    // Build pattern bar with time markers - uses FULL DAY from midnight
    const hourly24 = scores.todayHourlyScores || scores.hourlyForecast.slice(0, 24);
    
    // Safety check: make sure we have data
    if (!hourly24 || hourly24.length === 0) {
        patternHTML += '<div style="color: #666;">No pattern data available</div>';
        patternSection.innerHTML = patternHTML;
    } else {
        let segments = [];
        let currentType = null;
        let currentStart = 0;
        
        for (let i = 0; i < hourly24.length; i++) {
            const h = hourly24[i];
            if (!h) continue; // Skip if hour data is missing
            
            let type;
            
            if (h.score === 0) type = 'night';
            else if (h.score >= 4.5) type = 'sunny';
            else if (h.score >= 3.5) type = 'partly-cloudy';
            else if (h.score >= 2) type = 'cloudy';
            else type = 'rainy';
            
            if (type !== currentType) {
                if (currentType !== null && hourly24[currentStart]) {
                    segments.push({ 
                        type: currentType, 
                        start: currentStart, 
                        end: i,
                        startTime: hourly24[currentStart].time
                    });
                }
                currentType = type;
                currentStart = i;
            }
        }
        if (currentType !== null && hourly24[currentStart]) {
            segments.push({ 
                type: currentType, 
                start: currentStart, 
                end: hourly24.length,
                startTime: hourly24[currentStart].time
            });
        }
        
        const colors = {
            'sunny': '#FFD700',        // Bright gold (solid)
            'partly-cloudy': '#87CEEB', // Sky blue (solid)
            'cloudy': '#A9A9A9',        // Gray (solid)
            'rainy': '#4A5568',         // Dark blue-gray (solid)
            'night': '#0f1419'          // Very dark blue (solid) - more distinct from rainy
        };
        
        // Time markers above the bar
        patternHTML += '<div style="position: relative; margin-bottom: 5px; height: 20px;">';
        for (const seg of segments) {
            const leftPos = (seg.start / hourly24.length * 100).toFixed(2);
            const timeStr = getLocalTimeFromISO(seg.startTime);
            patternHTML += `<div style="position: absolute; left: ${leftPos}%; font-size: 11px; color: #333; font-weight: 500; transform: translateX(-50%); white-space: nowrap;">${timeStr}</div>`;
        }
        // Add end time marker at 100% (11:59 PM)
        patternHTML += `<div style="position: absolute; left: 100%; font-size: 11px; color: #333; font-weight: 500; transform: translateX(-100%); white-space: nowrap;">11:59 PM</div>`;
        patternHTML += '</div>';
        
        // Pattern bar
        patternHTML += '<div class="pattern-bar">';
        for (const seg of segments) {
            const width = ((seg.end - seg.start) / hourly24.length * 100).toFixed(2);
            patternHTML += `<div class="pattern-segment" style="width: ${width}%; background: ${colors[seg.type]}"></div>`;
        }
        patternHTML += '</div>';
        
        // Legend
        patternHTML += '<div class="pattern-legend">';
        patternHTML += '<div class="legend-item"><div class="legend-color" style="background: #FFD700"></div> Sunny</div>';
        patternHTML += '<div class="legend-item"><div class="legend-color" style="background: #87CEEB"></div> Partly Cloudy</div>';
        patternHTML += '<div class="legend-item"><div class="legend-color" style="background: #A9A9A9"></div> Cloudy</div>';
        patternHTML += '<div class="legend-item"><div class="legend-color" style="background: #4A5568"></div> Rainy</div>';
        patternHTML += '<div class="legend-item"><div class="legend-color" style="background: #0f1419"></div> Night</div>';
        patternHTML += '</div>';
        
        patternSection.innerHTML = patternHTML;
    }
    
    // Hourly forecast with horizontal scroll
    const hourlySection = document.querySelectorAll('.detail-section')[2];
    hourlySection.innerHTML = '<h2>24-Hour Forecast</h2>';
    const hourlyGrid = document.createElement('div');
    hourlyGrid.className = 'hourly-grid';
    
    hourlyGrid.innerHTML = scores.hourlyForecast.slice(0, 24).map(h => {
        const timeStr = getLocalTimeFromISO(h.time);
        const isDaytime = h.score > 0;
        const bgClass = isDaytime ? 'daytime' : 'nighttime';
        return `
            <div class="hourly-item ${bgClass}">
                <div class="hourly-time">${timeStr}</div>
                <div class="hourly-icon">${getWeatherIcon(h.weatherCode)}</div>
                <div class="hourly-score ${h.score > 0 ? getScoreColorClass(h.score) : 'night'}">${h.score > 0 ? h.score.toFixed(1) : 'N/A'}</div>
                <div class="hourly-temp">${h.temperature}¬∞F</div>
            </div>
        `;
    }).join('');
    
    hourlySection.appendChild(hourlyGrid);
    
    // 7-day forecast - filter based on city's local date
    const forecastSection = document.querySelectorAll('.detail-section')[3];
    forecastSection.innerHTML = '<h2>7-Day Forecast</h2>';
    const forecastList = document.createElement('div');
    forecastList.className = 'forecast-list';
    
    // Get today's date in the CITY'S timezone from the first daily entry
    const cityToday = scores.weekForecast[0].date;
    const weekData = scores.weekForecast.filter(day => day.date >= cityToday);
    
    forecastList.innerHTML = weekData.map((day, idx) => {
        // Parse date from YYYY-MM-DD format
        const dateParts = day.date.split('-');
        const dayName = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])).toLocaleDateString('en-US', { weekday: 'short' });
        const monthDay = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const isToday = idx === 0;
        
        return `
            <div class="forecast-day">
                <div>
                    <div style="font-weight: 600;">${isToday ? 'Today' : dayName}</div>
                    <div style="font-size: 13px; color: #666;">${monthDay}</div>
                </div>
                <div class="forecast-score ${day.avgScore > 0 ? getScoreColorClass(day.avgScore) : ''}">${day.avgScore > 0 ? day.avgScore.toFixed(1) : 'N/A'}</div>
                <div>
                    ${day.maxTemp}¬∞F / ${day.minTemp}¬∞F<br>
                    <span style="font-size: 13px; color: #666;">Peak: ${day.peakScore} at ${day.peakHour === 0 ? '12 AM' : day.peakHour === 12 ? '12 PM' : day.peakHour > 12 ? (day.peakHour - 12) + ' PM' : day.peakHour + ' AM'}</span><br>
                    <span style="font-size: 13px; color: #666;">${day.daylightHours} hrs daylight</span>
                </div>
            </div>
        `;
    }).join('');
    
    forecastSection.appendChild(forecastList);
}

function showCitiesView() {
    document.getElementById('citiesView').style.display = 'block';
    document.getElementById('detailView').style.display = 'none';
    document.getElementById('backButton').style.display = 'none';
}

async function deleteCity(index) {
    savedCities.splice(index, 1);
    
    // Save to server
    await saveCitiesToServer();
    
    renderCityCards();
}

// ============================================================
// SEARCH FUNCTIONALITY
// ============================================================

async function searchCities(query) {
    if (!query || query.length < 2) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=10&language=en&format=json`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = data.results.map(city => {
                const cityJSON = JSON.stringify(city).replace(/"/g, '&quot;');
                return `
                    <div class="search-result-item" onclick='addCity(${cityJSON})'>
                        <strong>${city.name}</strong>
                        <div class="city-details">${city.admin1 ? city.admin1 + ', ' : ''}${city.country}</div>
                    </div>
                `;
            }).join('');
            resultsDiv.style.display = 'block';
        } else {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="search-result-item" style="color: #999;">No cities found</div>';
            resultsDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Search error:', error);
    }
}

async function addCity(city) {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchInput').value = '';
    
    // Check 6 city limit BEFORE adding
    if (savedCities.length >= 6) {
        alert('You can only save up to 6 cities. Please delete one first.');
        return;
    }
    
    const exists = savedCities.find(c => c.latitude === city.latitude && c.longitude === city.longitude);
    if (exists) {
        renderCityCards();
        return;
    }
    
    savedCities.push({
        name: city.name,
        latitude: city.latitude,  // Consistent property names
        longitude: city.longitude,  // Consistent property names
        timezone: city.timezone
    });
    
    // Save to server
    await saveCitiesToServer();
    
    renderCityCards();
}

// ============================================================
// INITIALIZATION
// ============================================================

document.addEventListener('DOMContentLoaded', () => {
    // ML token is now received from server after authentication
    // No hardcoded token in public HTML for security
    
    renderCityCards();
    
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', (e) => {
        searchCities(e.target.value);
    });
    
    document.getElementById('searchBtn').addEventListener('click', () => {
        searchCities(searchInput.value);
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            document.getElementById('searchResults').style.display = 'none';
        }
    });
});
    </script>
</body>
</html>
